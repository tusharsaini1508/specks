<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LensAI ¬∑ precision fit 118‚Äì147 mm</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Face‚ÄëAPI (CNN models) -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0b1120;
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 16px 12px;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        h1 {
            font-weight: 800;
            font-size: 28px;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
            background: linear-gradient(145deg, #b4c6ff, #d6b0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subhead {
            color: #9aaec9;
            font-size: 14px;
            margin-bottom: 18px;
        }
        .camera-box {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4;
            border-radius: 28px;
            overflow: hidden;
            border: 2px solid rgba(255,215,100,0.3);
            box-shadow: 0 20px 35px -8px #00000080;
            background: #0f172a;
        }
        video, canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }
        video { transform: scaleX(-1); }
        canvas { pointer-events: none; z-index: 10; }
        .status-panel {
            margin: 20px 0 16px;
            background: rgba(20,30,55,0.8);
            backdrop-filter: blur(16px);
            border: 1px solid #2d3a5e;
            border-radius: 28px;
            padding: 20px 18px;
        }
        .frame-size {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.2;
            background: linear-gradient(145deg, #fcd34d, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .badge {
            background: #1e2a47;
            border: 1px solid #3b4e7a;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #cbd5e1;
            display: inline-block;
            margin-bottom: 8px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-top: 14px;
            color: #b8c7e7;
            font-size: 15px;
            border-bottom: 1px dashed #2f3d60;
            padding-bottom: 8px;
        }
        .capture-btn {
            background: #2f3e6b;
            border: none;
            width: 100%;
            padding: 18px 0;
            border-radius: 50px;
            font-weight: 700;
            font-size: 20px;
            color: #f0f4ff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 18px 0 14px;
            transition: 0.15s;
            box-shadow: 0 8px 0 #121c30;
            cursor: pointer;
        }
        .capture-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 #121c30; }
        .capture-btn:disabled {
            opacity: 0.4;
            transform: none;
            box-shadow: 0 5px 0 #121c30;
            pointer-events: none;
        }
        /* New attractive video button */
        .video-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(145deg, #e63946, #c92a3a);
            color: white;
            font-weight: 800;
            font-size: 20px;
            padding: 16px 32px;
            border-radius: 60px;
            text-decoration: none;
            margin: 10px 0 20px;
            width: 100%;
            border: 2px solid #ffb3b3;
            box-shadow: 0 10px 0 #7f1d1d, 0 10px 30px rgba(230, 57, 70, 0.5);
            transition: all 0.1s ease;
            letter-spacing: 1px;
        }
        .video-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 0 #7f1d1d, 0 15px 30px rgba(230, 57, 70, 0.6);
        }
        .video-button:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #7f1d1d;
        }
        .video-button .icon {
            font-size: 28px;
            filter: drop-shadow(0 2px 2px black);
        }
        .gallery {
            background: #0f1a2b;
            border-radius: 28px;
            padding: 18px 14px;
            border: 1px solid #293856;
        }
        .gallery h3 {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 14px;
            color: #bdd3ff;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .capture-grid {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: #3e5275 #1e2a3a;
        }
        .capture-grid::-webkit-scrollbar { height: 6px; }
        .capture-grid::-webkit-scrollbar-thumb { background: #3e5a88; border-radius: 10px; }
        .capture-card {
            min-width: 160px;
            background: #152237;
            border-radius: 20px;
            padding: 12px 10px;
            border: 1px solid #33485f;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }
        .thumb {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 16px;
            background: #1e2c40;
            object-fit: cover;
            border: 2px solid #4b618b;
        }
        .rec-tag {
            font-weight: 700;
            font-size: 14px;
            margin: 8px 0 3px;
            background: #293d60;
            padding: 4px 12px;
            border-radius: 40px;
            color: #e0ebff;
        }
        .meta-small {
            font-size: 11px;
            color: #8fa3cd;
        }
        .clear-btn {
            background: none;
            border: 1px solid #4a5e89;
            color: #bdd3ff;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 12px;
            margin-left: 12px;
            cursor: pointer;
        }
        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #9cb1d4;
        }
        .spinner { width: 18px; height: 18px; border: 2px solid #2b4168; border-top-color: #70a0ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .note { color: #738ab8; font-size: 12px; margin-top: 12px; }

        /* Modal overlay for form */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #172237;
            border-radius: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 28px 24px;
            border: 1px solid #3f5680;
            box-shadow: 0 25px 50px -12px black;
        }
        .modal-content h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #d0e0ff;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px 12px;
        }
        .full-width { grid-column: span 2; }
        label {
            font-size: 13px;
            font-weight: 600;
            color: #a5bbdf;
            display: block;
            margin-bottom: 4px;
        }
        input, select, textarea {
            width: 100%;
            background: #0d1a2c;
            border: 1px solid #334e77;
            border-radius: 18px;
            padding: 12px 16px;
            font-size: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
        }
        textarea { resize: vertical; min-height: 70px; }
        .readonly-field {
            background: #1e314a;
            border: 1px solid #5773a6;
            color: #ccdeff;
            font-weight: 600;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        .btn {
            flex: 1;
            padding: 14px;
            border-radius: 40px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background: #3f5e9c;
            color: white;
        }
        .btn-secondary {
            background: #2a3855;
            color: #b8d0ff;
            border: 1px solid #506a9a;
        }
        .power-group {
            background: #101c30;
            border-radius: 20px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .power-group h4 {
            color: #b4ccff;
            margin-bottom: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>‚çü LensAI ¬∑ precision fit </h1>
    <div class="subhead">CNN analysis ‚Ä¢ mm‚Äëaccurate frame size ‚Ä¢ customer intake</div>

    <!-- camera + overlay -->
    <div class="camera-box">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <!-- live status panel -->
    <div class="status-panel">
        <span class="badge" id="statusBadge">üì° initializing camera...</span>
        <div class="frame-size" id="frameSizeDisplay">--</div>
        <div class="detail-row"><span>üìè face distance</span> <span id="distanceLabel">--</span></div>
        <div class="detail-row"><span>üëÅÔ∏è pupillary distance (PD)</span> <span id="pdDisplay">-- mm</span></div>
        <div class="detail-row"><span>üßè face shape (CNN)</span> <span id="shapeDisplay">detecting...</span></div>
    </div>

    <!-- capture button (enabled only when optimal) -->
    <button class="capture-btn" id="captureBtn" disabled>
        <span>üì∏</span> CAPTURE & ENTER DETAILS
    </button>

    <!-- New attractive video button -->
    <a href="https://www.facebook.com/share/v/1De7qG61aG/" target="_blank" class="video-button">
        <span class="icon">‚ñ∂</span> WATCH FITTING VIDEO
    </a>

    <!-- gallery of previous captures -->
    <div class="gallery">
        <h3>üï∂Ô∏è past entries
            <button class="clear-btn" id="clearGalleryBtn">clear all</button>
        </h3>
        <div id="galleryContainer" class="capture-grid">
            <!-- cards will appear here -->
        </div>
        <div class="note">‚ú® all data .d on this device</div>
    </div>

    <!-- loader (hidden after models) -->
    <div id="loader" class="loading"><div class="spinner"></div><span>loading CNN models (face-api)</span></div>
</div>

<!-- Modal: Customer details form -->
<div class="modal" id="customerFormModal">
    <div class="modal-content">
        <h2>üë§ Customer details & prescription</h2>
        <form id="detailsForm">
            <div class="form-grid">
                <!-- Basic info -->
                <div class="full-width"><label>Full name *</label><input type="text" id="fullName" required></div>
                <div><label>Age *</label><input type="number" id="age" required min="1" max="120"></div>
                <div><label>Date of birth</label><input type="date" id="dob"></div>
                <div><label>Gender</label><select id="genderSelect"><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                <div class="full-width"><label>Address</label><textarea id="address" rows="2"></textarea></div>
                <div><label>Ward no.</label><input type="text" id="ward"></div>
                <div><label>Booth no. / PS no.</label><input type="text" id="booth"></div>
                <div class="full-width"><label>Mobile / WhatsApp *</label><input type="tel" id="mobile" required placeholder="e.g. 9876543210"></div>
            </div>

            <!-- Auto-detected fields (readonly) -->
            <div style="margin: 18px 0 10px; background:#1b2845; border-radius: 24px; padding: 14px;">
                <div class="detail-row"><span>üìê Recommended frame size (total width)</span> <span id="detectedFrameSize" class="readonly-field" style="padding:4px 12px;">--</span></div>
                <div class="detail-row"><span>üï∂Ô∏è Suggested frame type</span> <span id="detectedFrameType" class="readonly-field" style="padding:4px 12px;">--</span></div>
            </div>

            <!-- Power parameters (OD / OS) -->
            <div style="margin-top: 15px;">
                <h3 style="color:#b4ccff; font-size:18px; margin-bottom:8px;">üîé Power details</h3>
                <div class="power-group">
                    <h4>Right eye (O.D.)</h4>
                    <div class="form-grid">
                        <div><label>Spherical</label><input type="text" id="odSph" placeholder="e.g. -2.00"></div>
                        <div><label>Cylindrical</label><input type="text" id="odCyl" placeholder="e.g. -0.50"></div>
                        <div><label>Axis</label><input type="text" id="odAxis" placeholder="e.g. 180"></div>
                        <div><label>Prism</label><input type="text" id="odPrism"></div>
                        <div><label>Base</label><input type="text" id="odBase"></div>
                    </div>
                </div>
                <div class="power-group">
                    <h4>Left eye (O.S.)</h4>
                    <div class="form-grid">
                        <div><label>Spherical</label><input type="text" id="osSph"></div>
                        <div><label>Cylindrical</label><input type="text" id="osCyl"></div>
                        <div><label>Axis</label><input type="text" id="osAxis"></div>
                        <div><label>Prism</label><input type="text" id="osPrism"></div>
                        <div><label>Base</label><input type="text" id="osBase"></div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelFormBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ</button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    // ----- DOM elements -----
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusBadge = document.getElementById('statusBadge');
    const frameSizeDisplay = document.getElementById('frameSizeDisplay');
    const distanceLabel = document.getElementById('distanceLabel');
    const pdDisplay = document.getElementById('pdDisplay');
    const shapeDisplay = document.getElementById('shapeDisplay');
    const captureBtn = document.getElementById('captureBtn');
    const galleryDiv = document.getElementById('galleryContainer');
    const clearBtn = document.getElementById('clearGalleryBtn');
    const loader = document.getElementById('loader');
    const modal = document.getElementById('customerFormModal');
    const cancelFormBtn = document.getElementById('cancelFormBtn');
    const detailsForm = document.getElementById('detailsForm');

    // fields inside modal (auto‚Äëfilled)
    const detectedFrameSpan = document.getElementById('detectedFrameSize');
    const detectedTypeSpan = document.getElementById('detectedFrameType');

    // ----- state -----
    let modelsReady = false;
    let cameraActive = false;
    let currentStream = null;
    let detectionInterval = null;
    let lastDetection = null;                // latest detection result
    let lastRecommendedFrameMm = 0;           // recommended total frame width (118‚Äì147)
    let lastFrameType = '';                  // recommendation string
    let lastPdMm = 0;
    let lastShape = '';

    // collection of .d entries (max 15)
    let entries = [];

    // constants
    const AVERAGE_PD_MM = 63;                // reference adult PD
    const MIN_FRAME_MM = 118;
    const MAX_FRAME_MM = 147;

    // ----- load stored entries from localStorage -----
    function loadEntries() {
        try {
            const stored = localStorage.getItem('lensai_entries');
            if (stored) {
                entries = JSON.parse(stored);
                if (entries.length > 15) entries = entries.slice(-15);
            }
        } catch (e) { console.warn('failed to load entries', e); }
        renderGallery();
    }
    function .Entries() {
        try {
            localStorage.setItem('lensai_entries', JSON.stringify(entries));
        } catch (e) { console.warn('storage failed', e); }
        renderGallery();
    }

    // ----- render gallery cards -----
    function renderGallery() {
        if (!galleryDiv) return;
        if (entries.length === 0) {
            galleryDiv.innerHTML = '<div style="color:#6a7faa; padding:10px; text-align:center; width:100%;">no entries yet ‚Äî capture a face</div>';
            return;
        }
        let html = '';
        entries.slice().reverse().forEach(entry => {
            html += `<div class="capture-card">
                <img src="${entry.thumbnail}" class="thumb" alt="face" />
                <div class="rec-tag">${entry.name ? entry.name.slice(0,10) : '‚Äî'}</div>
                <div class="meta-small">${entry.frameSize} ¬∑ ${entry.shape}</div>
                <div class="meta-small">üìû ${entry.mobile || ''}</div>
            </div>`;
        });
        galleryDiv.innerHTML = html;
    }

    // ----- clear gallery -----
    clearBtn.addEventListener('click', () => {
        entries = [];
        .Entries();
    });

    // ----- load face-api models with fallback -----
    async function loadModels() {
        statusBadge.textContent = '‚è≥ loading AI models...';
        for (const url of [
            "https://justadudewhohacks.github.io/face-api.js/models/",
            "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/",
            "https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/"
        ]) {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(url);
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri(url);
                await faceapi.nets.ageGenderNet.loadFromUri(url);
                console.log(`‚úÖ models loaded from ${url}`);
                modelsReady = true;
                statusBadge.textContent = '‚úÖ ready ‚Äì show your face';
                loader.classList.add('hidden');
                return;
            } catch (e) { console.warn('load fail', e); }
        }
        modelsReady = false;
        statusBadge.textContent = '‚ö†Ô∏è offline mode ‚Äì limited';
        loader.classList.add('hidden');
    }

    // ----- start camera -----
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            });
            video.srcObject = stream;
            currentStream = stream;
            await new Promise(r => { video.onloadedmetadata = r; });
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            await video.play();
            cameraActive = true;
            statusBadge.textContent = modelsReady ? '‚úÖ show your face' : '‚ö†Ô∏è offline';
            startDetectionLoop();
        } catch (err) {
            statusBadge.textContent = '‚ùå camera access denied';
        }
    }

    // ----- periodic detection -----
    function startDetectionLoop() {
        if (detectionInterval) clearInterval(detectionInterval);
        detectionInterval = setInterval(async () => {
            if (!cameraActive || !video.videoWidth) return;
            if (modelsReady) {
                await detectFaceAndDraw();
            } else {
                drawOfflineOverlay();
            }
        }, 200);
    }

    // ----- detection + overlay + metrics update -----
    async function detectFaceAndDraw() {
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
            inputSize: 416,
            scoreThreshold: 0.5
        })).withFaceLandmarks(true).withAgeAndGender();

        lastDetection = detection;
        drawOverlay(detection);
        updateMetrics(detection);
    }

    // ----- draw overlay (mirrored) -----
    function drawOverlay(det) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!det) {
            ctx.font = 'bold 16px Inter';
            ctx.fillStyle = '#ffffffcc';
            ctx.shadowColor = '#000';
            ctx.shadowBlur = 8;
            ctx.fillText('üë§ no face', 24, 50);
            ctx.shadowBlur = 0;
            return;
        }

        ctx..();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);

        const box = det.detection.box;
        const cx = box.x + box.width/2;
        const cy = box.y + box.height/2;
        const radius = Math.max(box.width, box.height) * 0.58;
        const faceRatio = box.width / canvas.width;

        let ringColor = '#fbbf24';
        if (faceRatio < 0.22) ringColor = '#f59e0b';
        else if (faceRatio > 0.5) ringColor = '#ef4444';
        else ringColor = '#10b981';

        // outer glow
        ctx.beginPath();
        ctx.arc(cx, cy, radius+6, 0, 2*Math.PI);
        ctx.strokeStyle = ringColor + '80';
        ctx.lineWidth = 12;
        ctx.shadowBlur = 28;
        ctx.shadowColor = ringColor;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2*Math.PI);
        ctx.strokeStyle = ringColor;
        ctx.lineWidth = 4;
        ctx.shadowBlur = 20;
        ctx.stroke();

        // dashed inner ring
        ctx.beginPath();
        ctx.arc(cx, cy, radius-12, 0, 2*Math.PI);
        ctx.strokeStyle = '#ffffff80';
        ctx.lineWidth = 2.5;
        ctx.shadowBlur = 0;
        ctx.setLineDash([8, 14]);
        ctx.lineDashOffset = (Date.now() * 0.02) % 20;
        ctx.stroke();
        ctx.setLineDash([]);

        // landmarks
        if (det.landmarks) {
            ctx.fillStyle = '#ffffff';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#3888ff';
            det.landmarks.positions.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, 2*Math.PI);
                ctx.fill();
            });
        }
        ctx.restore();
    }

    // ----- update text fields, calculate frame mm (118‚Äì147), frame type -----
    function updateMetrics(det) {
        if (!det) {
            frameSizeDisplay.textContent = '--';
            distanceLabel.textContent = '--';
            pdDisplay.textContent = '--';
            shapeDisplay.textContent = '--';
            captureBtn.disabled = true;
            statusBadge.innerHTML = 'üë§ no face';
            return;
        }

        const box = det.detection.box;
        const faceRatio = box.width / canvas.width;
        let distanceStatus;
        if (faceRatio < 0.22) distanceStatus = 'too far';
        else if (faceRatio > 0.5) distanceStatus = 'too close';
        else distanceStatus = 'optimal';

        // ----- compute PD in mm and face width in mm -----
        let pdPx = null;
        let faceWidthMm = 0;
        if (det.landmarks) {
            const leftEye = det.landmarks.getLeftEye();
            const rightEye = det.landmarks.getRightEye();
            const l = leftEye[Math.floor(leftEye.length/2)];
            const r = rightEye[Math.floor(rightEye.length/2)];
            pdPx = Math.abs(r.x - l.x);
            if (pdPx > 0) {
                const mmPerPx = AVERAGE_PD_MM / pdPx;
                faceWidthMm = Math.round(box.width * mmPerPx);
            }
        }
        if (faceWidthMm === 0) {
            // fallback using average face width ~145mm and ratio
            faceWidthMm = Math.round(145 * (box.width / canvas.width));
        }

        // ----- recommended total frame width (118‚Äì147) -----
        // typical frame adds ~12mm to face width, then clamp
        let rawRecommended = faceWidthMm + 12;
        let recommendedFrame = Math.min(MAX_FRAME_MM, Math.max(MIN_FRAME_MM, rawRecommended));
        lastRecommendedFrameMm = recommendedFrame;

        // ----- PD display (using same scaling) -----
        let pdValue = '--';
        if (pdPx) {
            pdValue = Math.round((pdPx / canvas.width) * 140) + ' mm';
        }

        // ----- face shape -----
        let shape = 'oval';
        if (det.landmarks) {
            const jaw = det.landmarks.getJawOutline();
            const ratioWH = box.width / box.height;
            if (ratioWH > 0.95 && ratioWH < 1.08) shape = 'round';
            else if (ratioWH <= 0.9) shape = 'oval';
            else if (ratioWH >= 1.1) shape = 'long';
            else shape = 'square';
        }
        lastShape = shape;

        // ----- frame type suggestion based on shape, gender, age -----
        let gender = det.gender || 'neutral';
        let age = det.age ? Math.round(det.age) : 30;
        let suggestion = '';
        if (shape === 'round') suggestion = 'angular / square frames';
        else if (shape === 'oval') suggestion = 'aviators, wayfarers';
        else if (shape === 'square') suggestion = 'round / cat-eye';
        else if (shape === 'heart') suggestion = 'bottom-heavy';
        else if (shape === 'long') suggestion = 'oversized / bold temples';
        else suggestion = 'classic rectangle';
        if (gender === 'female' && age < 35) suggestion += ' ¬∑ trendy';
        else if (gender === 'male' && age > 45) suggestion += ' ¬∑ conservative';
        lastFrameType = suggestion;

        // update DOM
        frameSizeDisplay.textContent = recommendedFrame + ' mm';
        distanceLabel.textContent = distanceStatus;
        pdDisplay.textContent = pdValue;
        shapeDisplay.textContent = shape;

        // enable/disable capture
        captureBtn.disabled = (distanceStatus !== 'optimal');

        statusBadge.innerHTML = distanceStatus === 'optimal' ? `‚úÖ locked ¬∑ ${shape}` : (distanceStatus === 'too far' ? '‚¨ÖÔ∏è move closer' : '‚û°Ô∏è step back');
    }

    function drawOfflineOverlay() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '16px Inter';
        ctx.fillStyle = '#ffffffcc';
        ctx.shadowBlur = 6;
        ctx.fillText('üì¥ offline mode', 24, 50);
        ctx.shadowBlur = 0;
    }

    // ----- show modal and prefill detected values -----
    function openFormModal() {
        if (!lastDetection) {
            alert('No face data. Please capture again.');
            return;
        }
        detectedFrameSpan.textContent = lastRecommendedFrameMm ? lastRecommendedFrameMm + ' mm' : '--';
        detectedTypeSpan.textContent = lastFrameType || '--';
        // Optionally prefill gender from detection
        if (lastDetection.gender) {
            document.getElementById('genderSelect').value = lastDetection.gender.toLowerCase();
        }
        if (lastDetection.age) {
            document.getElementById('age').value = Math.round(lastDetection.age);
        }
        modal.classList.add('active');
    }

    cancelFormBtn.addEventListener('click', () => {
        modal.classList.remove('active');
    });

    // ----- handle form submit: combine with captured data and . -----
    detailsForm.addEventListener('submit', (e) => {
        e.preventDefault();

        // generate thumbnail from video
        const thumbCanvas = document.createElement('canvas');
        thumbCanvas.width = 100;
        thumbCanvas.height = 100;
        const tCtx = thumbCanvas.getContext('2d');
        tCtx.translate(100, 0);
        tCtx.scale(-1, 1);
        tCtx.drawImage(video, 0, 0, 100, 100);
        const thumbData = thumbCanvas.toDataURL('image/jpeg', 0.7);

        const name = document.getElementById('fullName').value.trim() || 'Unknown';
        const age = document.getElementById('age').value;
        const dob = document.getElementById('dob').value;
        const gender = document.getElementById('genderSelect').value;
        const address = document.getElementById('address').value;
        const ward = document.getElementById('ward').value;
        const booth = document.getElementById('booth').value;
        const mobile = document.getElementById('mobile').value;
        const odSph = document.getElementById('odSph').value;
        const odCyl = document.getElementById('odCyl').value;
        const odAxis = document.getElementById('odAxis').value;
        const odPrism = document.getElementById('odPrism').value;
        const odBase = document.getElementById('odBase').value;
        const osSph = document.getElementById('osSph').value;
        const osCyl = document.getElementById('osCyl').value;
        const osAxis = document.getElementById('osAxis').value;
        const osPrism = document.getElementById('osPrism').value;
        const osBase = document.getElementById('osBase').value;

        const entry = {
            thumbnail: thumbData,
            name: name,
            age: age,
            dob: dob,
            gender: gender,
            address: address,
            ward: ward,
            booth: booth,
            mobile: mobile,
            frameSize: lastRecommendedFrameMm + ' mm',
            shape: lastShape,
            frameType: lastFrameType,
            pd: lastPdMm,
            power: { od: { sph: odSph, cyl: odCyl, axis: odAxis, prism: odPrism, base: odBase },
                     os: { sph: osSph, cyl: osCyl, axis: osAxis, prism: osPrism, base: osBase } },
            timestamp: Date.now()
        };

        entries.push(entry);
        if (entries.length > 15) entries.shift();
        .Entries();

        modal.classList.remove('active');
        detailsForm.reset(); // optional, but keep detected values for next?
        // re-show detected frame fields as they were before reset
        detectedFrameSpan.textContent = lastRecommendedFrameMm + ' mm';
        detectedTypeSpan.textContent = lastFrameType;
    });

    // ----- capture button click -> open modal -----
    captureBtn.addEventListener('click', openFormModal);

    // ----- cleanup -----
    window.addEventListener('beforeunload', () => {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        if (detectionInterval) clearInterval(detectionInterval);
    });

    // ----- bootstrap -----
    loadEntries();
    loadModels().then(() => startCamera());
})();
</script>
</body>
</html>
